- name: Get current NTP servers [IOS]
  cli_command:
    command: show run | i ntp server
  register: output

- name: Remove non config lines [IOS]
  set_fact:
    configured_servers: "{{ output.stdout_lines | difference(dummy_list) }}"
  vars:
    dummy_list:
      - "Building configuration..."

- name: Print current NTP servers [IOS]
  debug:
    var: configured_servers

- name: Determine configuration delta for reporting [IOS]
  set_fact:
    missing_servers: "{{ required_servers | difference(configured_servers) }}"
    unnecessary_servers: "{{ configured_servers | difference(required_servers) }}"

- name: Create list of NEW servers to configure [IOS]
  set_fact:
    in_servers: "{{ in_servers }} + [ '{{ item.split(' ')[-1] }}' ]"
  with_items: "{{ missing_servers }}"

- name: Create list of servers to remove [IOS]
  set_fact:
    out_servers: "{{ out_servers }} + [ '{{ item.split(' ')[-1] }}' ]"
  with_items: "{{ unnecessary_servers }}"

- name: Print out fidings for reporting [IOS]
  debug:
    msg:
    - "We are missing the following NTP Servers in IOS: {{ in_servers | list }}"
    - "We will delete these NTP Servers in IOS: {{ out_servers | list }}"